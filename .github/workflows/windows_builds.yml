name: ðŸ Build Custom Godot Templates (Windows)

on:
  workflow_dispatch:
    inputs:
      build_x86_32:
        description: 'Build x86_32 (32-bit)'
        required: false
        type: boolean
        default: true
      build_x86_64:
        description: 'Build x86_64 (64-bit)'
        required: false
        type: boolean
        default: true
      build_arm64:
        description: 'Build ARM64'
        required: false
        type: boolean
        default: true

      enable_d3d12:
        description: 'Enable DirectX 12 (auto-installs deps). If false, d3d12=no.'
        required: false
        type: boolean
        default: false

      production:
        description: 'Enable production build'
        required: false
        type: boolean
        default: false

      lto:
        description: 'Link-Time Optimization (LTO)'
        required: false
        type: choice
        default: 'none'
        options:
          - 'none'
          - 'auto'
          - 'full'
          - 'thin'

env:
  PYTHONIOENCODING: utf8
  SCONS_CACHE_MSVC_CONFIG: true

jobs:
  generate-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.mx.outputs.matrix }}
    steps:
      - id: mx
        run: |
          set -euo pipefail

          archs=()
          if [ "${{ inputs.build_x86_32 }}" = "true" ]; then archs+=("x86_32"); fi
          if [ "${{ inputs.build_x86_64 }}" = "true" ]; then archs+=("x86_64"); fi
          if [ "${{ inputs.build_arm64 }}" = "true" ]; then archs+=("arm64"); fi

          if [ "${#archs[@]}" -eq 0 ]; then
            echo "No architectures selected."
            exit 1
          fi

          json='{"include":[]}'
          for a in "${archs[@]}"; do
            for t in template_debug template_release; do
              for s in gui console; do
                json=$(echo "$json" | jq -c --arg a "$a" --arg t "$t" --arg s "$s" \
                  '.include += [{"arch":$a,"target":$t,"subsystem":$s,"cache_name":("windows-" + $t + "-" + $a + "-" + $s)}]')
              done
            done
          done

          echo "matrix=$json" >> "$GITHUB_OUTPUT"

  build:
    needs: generate-matrix
    runs-on: windows-latest
    timeout-minutes: 120
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.generate-matrix.outputs.matrix) }}

    name: ${{ matrix.target }} ${{ matrix.arch }} (${{ matrix.subsystem }})

    steps:
      - name: Checkout user repo
        uses: actions/checkout@v4

      - name: Checkout Godot Engine
        uses: actions/checkout@v4
        with:
          repository: godotengine/godot
          ref: 4.6-stable
          path: godot

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install SCons
        run: pip install scons

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: ${{ matrix.arch == 'x86_32' && 'x86' || matrix.arch }}

      - name: Install D3D12 deps (Godot official script)
        if: inputs.enable_d3d12 == true
        working-directory: godot
        shell: pwsh
        id: d3d12
        run: |
          python misc\scripts\install_d3d12_sdk_windows.py
          if ($LASTEXITCODE -eq 0) {
            "D3D12_AVAILABLE=yes" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          } else {
            "D3D12_AVAILABLE=no" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          }

      - name: Generate custom.py and sanitized build profile
        shell: python
        run: |
          import json, os

          CRITICAL = {"Mutex", "Time", "Window"}

          # build_profile.gdbuild is at repo root
          src = "build_profile.gdbuild"
          dst_profile = os.path.join("godot", "sanitized_build.gdbuild")
          dst_custom = os.path.join("godot", "custom.py")

          if not os.path.exists(src):
              raise SystemExit("ERROR: build_profile.gdbuild not found in repo root")

          with open(src, "r", encoding="utf-8") as f:
              data = json.load(f)

          data.setdefault("disabled_build_options", {})
          data.setdefault("disabled_classes", [])

          # ONLY remove the 3 critical classes (nothing else)
          before = list(data["disabled_classes"])
          data["disabled_classes"] = [c for c in data["disabled_classes"] if c not in CRITICAL]
          removed = sorted(set(before) - set(data["disabled_classes"]))
          if removed:
              print("Removed critical classes from disabled_classes:", ", ".join(removed))

          # Write sanitized .gdbuild (still JSON)
          with open(dst_profile, "w", encoding="utf-8", newline="\n") as f:
              json.dump(data, f, indent=2)

          # Generate custom.py: disabled_build_options + forced defaults
          options = data.get("disabled_build_options", {})
          with open(dst_custom, "w", encoding="utf-8", newline="\n") as f:
              for k, v in options.items():
                  f.write(f'{k}="{"yes" if bool(v) else "no"}"\n')

              f.write("\n# Forced defaults (size-focused)\n")
              f.write('optimize="size"\n')
              f.write('debug_symbols="no"\n')

              # Optional production (default off)
              prod = "${{ inputs.production }}" == "true"
              if prod:
                  f.write('production="yes"\n')

              # Optional LTO (default none)
              lto_mode = "${{ inputs.lto }}".strip()
              if lto_mode and lto_mode != "none":
                  f.write(f'lto="{lto_mode}"\n')

              # D3D12 (default off unless enabled AND deps available)
              enable_d3d12 = "${{ inputs.enable_d3d12 }}" == "true"
              d3d12_available = "${{ steps.d3d12.outputs.D3D12_AVAILABLE }}" == "yes"
              if enable_d3d12 and d3d12_available:
                  f.write('d3d12="yes"\n')
              else:
                  f.write('d3d12="no"\n')

          print("Wrote:", dst_profile)
          print("Wrote:", dst_custom)

      - name: Dump custom.py (debug)
        shell: pwsh
        run: |
          Write-Host "==== custom.py ===="
          Get-Content godot\custom.py

      - name: Compile
        working-directory: godot
        shell: cmd
        run: |
          echo Building ${{ matrix.target }} for ${{ matrix.arch }} (${{ matrix.subsystem }})
          scons p=windows target=${{ matrix.target }} arch=${{ matrix.arch }} windows_subsystem=${{ matrix.subsystem }} build_profile=sanitized_build.gdbuild -j4

      - name: Cleanup non-essential build files
        shell: pwsh
        run: |
          Remove-Item godot/bin/* -Include *.exp,*.lib,*.pdb,*.ilk -Force -ErrorAction SilentlyContinue
          Get-ChildItem godot/bin/*.exe | ForEach-Object {
            $kb = [math]::Round($_.Length / 1KB, 2)
            Write-Host "Built: $($_.Name) (${kb} KB)"
          }

      - name: Test executable (skip ARM64)
        if: matrix.arch != 'arm64'
        shell: pwsh
        run: |
          $exe = Get-ChildItem godot/bin/*.exe | Select-Object -First 1
          if (-not $exe) { throw "No exe found" }
          & $exe.FullName --version
          & $exe.FullName --help | Select-Object -First 10

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.cache_name }}
          path: godot/bin/*.exe
          retention-days: 7
          if-no-files-found: error

  combine:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: all_templates

      - name: Combine
        run: |
          mkdir -p combined_templates
          find all_templates -name "*.exe" -exec cp {} combined_templates/ \;
          ls -lh combined_templates || true

      - name: Upload combined
        uses: actions/upload-artifact@v4
        with:
          name: godot-4.6-custom-templates-complete
          path: combined_templates/
          retention-days: 30
