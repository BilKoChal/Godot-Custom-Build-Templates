name: ðŸ Build Custom Godot Templates (Windows)

on:
  workflow_dispatch:
    inputs:
      godot_ref:
        description: 'Godot ref (tag/branch/commit). Example: 4.6-stable'
        required: false
        type: string
        default: '4.6-stable'

      build_console:
        description: 'Build console variants too (adds _console.exe outputs)'
        required: false
        type: boolean
        default: false

      build_x86_32:
        description: 'Build x86_32 (32-bit)'
        required: false
        type: boolean
        default: true
      build_x86_64:
        description: 'Build x86_64 (64-bit)'
        required: false
        type: boolean
        default: true
      build_arm64:
        description: 'Build ARM64'
        required: false
        type: boolean
        default: true

      enable_d3d12:
        description: 'Enable Direct3D 12 (installs deps). If unchecked, d3d12=no is forced.'
        required: false
        type: boolean
        default: false

      production:
        description: 'production=yes'
        required: false
        type: boolean
        default: false

      lto:
        description: 'LTO mode (thin requires LLVM).'
        required: false
        type: choice
        default: 'none'
        options:
          - 'none'
          - 'auto'
          - 'full'
          - 'thin'

      optimize:
        description: 'Optimization focus'
        required: false
        type: choice
        default: 'size'
        options:
          - 'speed'
          - 'size'
          - 'size_extra'

      debug_symbols:
        description: 'Include debug symbols'
        required: false
        type: choice
        default: 'no'
        options:
          - 'no'
          - 'yes'

env:
  PYTHONIOENCODING: utf8
  SCONS_CACHE_MSVC_CONFIG: true

jobs:
  generate-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.mx.outputs.matrix }}
    steps:
      - id: mx
        run: |
          set -euo pipefail

          archs=()
          if [ "${{ inputs.build_x86_32 }}" = "true" ]; then archs+=("x86_32"); fi
          if [ "${{ inputs.build_x86_64 }}" = "true" ]; then archs+=("x86_64"); fi
          if [ "${{ inputs.build_arm64 }}" = "true" ]; then archs+=("arm64"); fi
          if [ "${#archs[@]}" -eq 0 ]; then
            echo "No architectures selected."
            exit 1
          fi

          subs=("gui")
          if [ "${{ inputs.build_console }}" = "true" ]; then
            subs=("gui" "console")
          fi

          json='{"include":[]}'
          for a in "${archs[@]}"; do
            for t in template_debug template_release; do
              for s in "${subs[@]}"; do
                json=$(echo "$json" | jq -c --arg a "$a" --arg t "$t" --arg s "$s" \
                  '.include += [{"arch":$a,"target":$t,"subsystem":$s,"cache_name":("windows-" + $t + "-" + $a + "-" + $s)}]')
              done
            done
          done

          echo "matrix=$json" >> "$GITHUB_OUTPUT"

  build:
    needs: generate-matrix
    runs-on: windows-latest
    timeout-minutes: 120
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.generate-matrix.outputs.matrix) }}

    name: ${{ matrix.target }} ${{ matrix.arch }} (${{ matrix.subsystem }})

    steps:
      - name: Checkout user repo
        uses: actions/checkout@v4

      - name: Checkout Godot Engine
        uses: actions/checkout@v4
        with:
          repository: godotengine/godot
          ref: ${{ inputs.godot_ref }}
          path: godot

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install SCons
        run: pip install scons

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: ${{ matrix.arch == 'x86_32' && 'x86' || matrix.arch }}

      - name: Set default D3D12 mode (no)
        id: d3d12mode
        shell: pwsh
        run: |
          "D3D12_MODE=no" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

      - name: Install D3D12 deps (Godot official script)
        if: inputs.enable_d3d12 == true
        working-directory: godot
        shell: pwsh
        run: |
          python misc\scripts\install_d3d12_sdk_windows.py
          if ($LASTEXITCODE -eq 0) {
            "D3D12_MODE=yes" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          } else {
            Write-Host "D3D12 deps install failed; forcing d3d12=no"
            "D3D12_MODE=no" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          }
        continue-on-error: true

      - name: Generate sanitized build profile + custom.py
        shell: python
        run: |
          import json, os

          CRITICAL = {"Mutex", "Time", "Window"}

          src = "build_profile.gdbuild"  # repo root
          dst_profile = os.path.join("godot", "sanitized_build.gdbuild")
          dst_custom = os.path.join("godot", "custom.py")

          if not os.path.exists(src):
              raise SystemExit("ERROR: build_profile.gdbuild not found in repo root")

          with open(src, "r", encoding="utf-8") as f:
              data = json.load(f)

          data.setdefault("disabled_build_options", {})
          data.setdefault("disabled_classes", [])

          # ONLY remove the 3 critical classes
          data["disabled_classes"] = [c for c in data["disabled_classes"] if c not in CRITICAL]

          with open(dst_profile, "w", encoding="utf-8", newline="\n") as f:
              json.dump(data, f, indent=2)

          # Generate custom.py from disabled_build_options (keep it simple)
          options = data.get("disabled_build_options", {})
          with open(dst_custom, "w", encoding="utf-8", newline="\n") as f:
              for k, v in options.items():
                  f.write(f'{k}="{"yes" if bool(v) else "no"}"\n")

      - name: Decide LLVM usage (ThinLTO => use_llvm=yes)
        id: llvm
        shell: pwsh
        run: |
          if ("${{ inputs.lto }}" -eq "thin") {
            "USE_LLVM=yes" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          } else {
            "USE_LLVM=no" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          }

      - name: Compile
        working-directory: godot
        shell: cmd
        run: |
          echo Building ${{ matrix.target }} for ${{ matrix.arch }} (${{ matrix.subsystem }})

          set USE_LLVM_FLAG=
          if "${{ steps.llvm.outputs.USE_LLVM }}"=="yes" set USE_LLVM_FLAG=use_llvm=yes

          scons ^
            p=windows ^
            target=${{ matrix.target }} ^
            arch=${{ matrix.arch }} ^
            windows_subsystem=${{ matrix.subsystem }} ^
            build_profile=sanitized_build.gdbuild ^
            d3d12=${{ steps.d3d12mode.outputs.D3D12_MODE }} ^
            debug_symbols=${{ inputs.debug_symbols }} ^
            optimize=${{ inputs.optimize }} ^
            lto=${{ inputs.lto }} ^
            production=${{ inputs.production && 'yes' || 'no' }} ^
            %USE_LLVM_FLAG% ^
            -j4

      - name: Rename outputs to requested format
        shell: pwsh
        run: |
          $target = "${{ matrix.target }}"
          $arch = "${{ matrix.arch }}"
          $sub = "${{ matrix.subsystem }}"

          $mode = if ($target -eq "template_debug") { "debug" } else { "release" }
          $suffix = if ($sub -eq "console") { "_console" } else { "" }

          # Pick the produced exe
          $exe = Get-ChildItem "godot/bin" -Filter "*.exe" | Select-Object -First 1
          if (-not $exe) { throw "No .exe found in godot/bin" }

          $outName = "windows_${mode}_${arch}${suffix}.exe"
          $outPath = Join-Path "godot/bin" $outName

          if (Test-Path $outPath) { Remove-Item $outPath -Force }
          Rename-Item -Path $exe.FullName -NewName $outName

          Write-Host "Renamed to: $outName"

      - name: Package zip (this job)
        shell: pwsh
        run: |
          $zipName = "${{ matrix.cache_name }}.zip"
          $zipPath = Join-Path (Get-Location) $zipName

          if (Test-Path $zipPath) { Remove-Item $zipPath -Force }

          $files = Get-ChildItem "godot/bin" -Filter "windows_*.exe"
          if (-not $files) { throw "No windows_*.exe files to zip" }

          Compress-Archive -Path $files.FullName -DestinationPath $zipPath
          Write-Host "Created: $zipName"

      - name: Upload job zip
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.cache_name }}
          path: ${{ matrix.cache_name }}.zip
          retention-days: 7
          if-no-files-found: error

  combine:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: all_zips

      - name: Combine into one zip
        run: |
          set -euo pipefail
          mkdir -p combined
          find all_zips -name "*.zip" -print -exec unzip -o {} -d combined \;
          (cd combined && ls -lh)

          # Final downloadable zip
          zip -r godot-windows-custom-templates.zip combined

      - name: Upload combined zip
        uses: actions/upload-artifact@v4
        with:
          name: godot-windows-custom-templates
          path: godot-windows-custom-templates.zip
          retention-days: 30
